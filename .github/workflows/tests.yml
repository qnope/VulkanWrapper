name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: ubuntu-24.04

    env:
      VCPKG_DEFAULT_TRIPLET: x64-linux-clang
      VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
      CC: clang-20
      CXX: clang++-20
      CXXFLAGS: "-stdlib=libc++"
      LDFLAGS: "-stdlib=libc++ -lc++abi"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Export GitHub Actions cache environment variables
      uses: actions/github-script@v7
      with:
        script: |
          core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
          core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

    - name: Install LLVM/Clang 20
      run: |
        wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | sudo tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
        sudo add-apt-repository -y "deb http://apt.llvm.org/noble/ llvm-toolchain-noble-20 main"
        sudo apt-get update
        sudo apt-get install -y clang-20 libc++-20-dev libc++abi-20-dev llvm-20

    - name: Install system dependencies
      run: |
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          pkg-config \
          autoconf \
          autoconf-archive \
          automake \
          libtool \
          libltdl-dev \
          mesa-vulkan-drivers \
          libx11-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxcursor-dev \
          libxi-dev \
          libwayland-dev \
          libxkbcommon-dev \
          libasound2-dev \
          libpulse-dev

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '3a3285c4878c7f5a957202201ba41e6fdeba8db4'

    - name: Create vcpkg triplet for libc++
      run: |
        cat > ${{ github.workspace }}/vcpkg/triplets/x64-linux-clang.cmake << 'EOF'
        set(VCPKG_TARGET_ARCHITECTURE x64)
        set(VCPKG_CRT_LINKAGE dynamic)
        set(VCPKG_LIBRARY_LINKAGE static)
        set(VCPKG_CMAKE_SYSTEM_NAME Linux)
        set(VCPKG_C_FLAGS "")
        set(VCPKG_CXX_FLAGS "-stdlib=libc++")
        set(VCPKG_LINKER_FLAGS "-stdlib=libc++ -lc++abi")
        EOF

    - name: Cache vcpkg installed packages
      uses: actions/cache@v4
      id: vcpkg-cache
      with:
        path: |
          ${{ github.workspace }}/build/vcpkg_installed
        key: vcpkg-installed-${{ runner.os }}-${{ hashFiles('vcpkg.json', '.github/workflows/tests.yml') }}-v3
        restore-keys: |
          vcpkg-installed-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}-
          vcpkg-installed-${{ runner.os }}-

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DENABLE_COVERAGE=ON \
          -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake \
          -DVCPKG_TARGET_TRIPLET=x64-linux-clang \
          -DCMAKE_C_COMPILER=clang-20 \
          -DCMAKE_CXX_COMPILER=clang++-20 \
          -DCMAKE_CXX_FLAGS="-stdlib=libc++ -fPIC" \
          -DCMAKE_C_FLAGS="-fPIC" \
          -DCMAKE_EXE_LINKER_FLAGS="-stdlib=libc++ -lc++abi" \
          -DCMAKE_SHARED_LINKER_FLAGS="-stdlib=libc++ -lc++abi" \
          -G Ninja

    - name: Build
      run: cmake --build build --parallel

    - name: Create coverage directory
      run: mkdir -p build/coverage

    - name: Run tests
      run: |
        failed=0
        for test_exe in build/VulkanWrapper/tests/*Tests; do
          if [ -x "$test_exe" ]; then
            echo "Running $test_exe..."
            if ! "$test_exe"; then
              failed=1
            fi
          fi
        done
        exit $failed
      env:
        # Use Mesa's software renderer for Vulkan tests
        VK_ICD_FILENAMES: /usr/share/vulkan/icd.d/lvp_icd.x86_64.json
        # Add validation layers from vcpkg
        VK_ADD_LAYER_PATH: ${{ github.workspace }}/build/vcpkg_installed/x64-linux-clang/share/vulkan/explicit_layer.d
        LIBGL_ALWAYS_SOFTWARE: 1
        # Coverage profiling output
        LLVM_PROFILE_FILE: ${{ github.workspace }}/build/coverage/%p-%m.profraw

    - name: Generate coverage report
      run: |
        llvm-profdata-20 merge -sparse build/coverage/*.profraw -o build/coverage.profdata

        echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        llvm-cov-20 report \
          build/VulkanWrapper/libVulkanWrapperCoreLibrary.so \
          -instr-profile=build/coverage.profdata \
          -ignore-filename-regex='.*/(vcpkg_installed|tests|examples)/.*' \
          >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
