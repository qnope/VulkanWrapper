name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: ubuntu-24.04

    env:
      VCPKG_DEFAULT_TRIPLET: x64-linux-clang
      VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
      CC: clang-20
      CXX: clang++-20
      CXXFLAGS: "-stdlib=libc++"
      LDFLAGS: "-stdlib=libc++ -lc++abi"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Export GitHub Actions cache environment variables
      uses: actions/github-script@v7
      with:
        script: |
          core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
          core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

    - name: Install LLVM/Clang 20
      run: |
        wget -qO- https://apt.llvm.org/llvm-snapshot.gpg.key | sudo tee /etc/apt/trusted.gpg.d/apt.llvm.org.asc
        sudo add-apt-repository -y "deb http://apt.llvm.org/noble/ llvm-toolchain-noble-20 main"
        sudo apt-get update
        sudo apt-get install -y clang-20 libc++-20-dev libc++abi-20-dev

    - name: Install system dependencies
      run: |
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          pkg-config \
          ccache \
          autoconf \
          autoconf-archive \
          automake \
          libtool \
          libltdl-dev \
          mesa-vulkan-drivers \
          libx11-dev \
          libxrandr-dev \
          libxinerama-dev \
          libxcursor-dev \
          libxi-dev \
          libwayland-dev \
          libxkbcommon-dev \
          libasound2-dev \
          libpulse-dev

    - name: Install Vulkan SDK
      run: |
        wget -qO- https://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo tee /etc/apt/trusted.gpg.d/lunarg.asc
        sudo wget -qO /etc/apt/sources.list.d/lunarg-vulkan-noble.list https://packages.lunarg.com/vulkan/lunarg-vulkan-noble.list
        sudo apt-get update
        sudo apt-get install -y vulkan-sdk

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1
      with:
        key: ${{ runner.os }}-ccache

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '3a3285c4878c7f5a957202201ba41e6fdeba8db4'

    - name: Create vcpkg triplet for libc++
      run: |
        cat > ${{ github.workspace }}/vcpkg/triplets/x64-linux-clang.cmake << 'EOF'
        set(VCPKG_TARGET_ARCHITECTURE x64)
        set(VCPKG_CRT_LINKAGE dynamic)
        set(VCPKG_LIBRARY_LINKAGE static)
        set(VCPKG_CMAKE_SYSTEM_NAME Linux)
        set(VCPKG_C_FLAGS "")
        set(VCPKG_CXX_FLAGS "-stdlib=libc++")
        set(VCPKG_LINKER_FLAGS "-stdlib=libc++ -lc++abi")
        EOF

    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake \
          -DVCPKG_TARGET_TRIPLET=x64-linux-clang \
          -DCMAKE_C_COMPILER=clang-20 \
          -DCMAKE_CXX_COMPILER=clang++-20 \
          -DCMAKE_CXX_FLAGS="-stdlib=libc++ -fPIC" \
          -DCMAKE_C_FLAGS="-fPIC" \
          -DCMAKE_EXE_LINKER_FLAGS="-stdlib=libc++ -lc++abi" \
          -DCMAKE_SHARED_LINKER_FLAGS="-stdlib=libc++ -lc++abi" \
          -DCMAKE_C_COMPILER_LAUNCHER=ccache \
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
          -G Ninja

    - name: Build
      run: cmake --build build --parallel --target MemoryTests ImageTests VulkanTests

    - name: Run tests
      run: |
        ctest --test-dir build --output-on-failure --timeout 120
      env:
        # Use Mesa's software renderer for Vulkan tests
        VK_ICD_FILENAMES: /usr/share/vulkan/icd.d/lvp_icd.x86_64.json
        LIBGL_ALWAYS_SOFTWARE: 1
